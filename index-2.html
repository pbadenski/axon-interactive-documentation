<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.string/3.2.0/underscore.string.js"></script>

<style>
rect {
  opacity: 0.5;
  fill: white;
  stroke: black;
}
path {
  opacity: 0.5;
  fill: white;
  stroke: black;
}
.ui-effects-transfer {
  border: 3px dotted black;
}
.highlight {
  background-color: #60a0d0;
}
</style>
<script>
var dashize = function (word) {
  return word.replace(/\s+/g, '-').toLowerCase(); 
}
var createVerticalTable = function (model) {
 var concat = function (x, xs) { return x + xs };
 return "<div style='float: left; padding: 10px'>" + 
    "<div style='text-align: center'>" + model.name + "</div>" +
      "<table border='1' class='" + dashize(model.name) + "'>" +
         "<tr>" +
           _.reduce(_.mapObject(model.data[0], function (value, key) {
             return "<td class='" + key + "-label'>" + key + "</td>";
           }), concat, "") +
         "</tr>" +
      _.reduce(_.map(model.data, function (each, idx) { 
         return "<tr class='" + idx + "'>" +
             _.reduce(_.mapObject(each, function (value, key) {
               return "<td class='" + key + "'>" + value + "</td>"
             }), concat, "") +
          "</tr>";
         }), concat, "") +
       "</table>" +
  "</div>";
}
var createHorizontalTable = function (model) {
 var concat = function (x, xs) { return x + xs };
 return "<div style='float: left; padding: 10px'>" + 
    "<div style='text-align: center'>" + model.name + "</div>" +
      "<table border='1' class='" + dashize(model.name) + "'>" +
         _.reduce(_.mapObject(model.data[0], function (value, key) {
           return "<tr>" +
             "<td class='" + key + "-label'>" + key + "</td>" +
            _.reduce(_.map(model.data, function (each, idx) { 
              return "<td class='" + idx + " " + key + "'>" + each[key] + "</td>";
             }), concat, "") +
          "</tr>";
         }), concat, "") +
       "</table>" +
  "</div>"
}
jQuery.fn.extend({
    highlight: function (o, done) {
      done = done || function () { };
      d3.selectAll($(this).toArray())
        .style("fill", "white")
        .style("background-color", "white")
        .transition()
        .style("fill", o.color)
        .style("background-color", o.color)
        .duration(o.duration/2)
        .transition()
        .style("fill", "white")
        .style("background-color", "white")
        .each("end", done)
    }
});
$(function () {
  var ANIMATION_PAUSE = 1500;
  var next = function () {
     if (toProcess.length > 0) { 
       toProcess.shift()()
     }
  }
  var animateNext = function () { 
    if (toProcess.length > 0) { 
      setTimeout(next, ANIMATION_PAUSE) 
    } 
  }; 
  var toProcess = [ 
     function () {
       $(".ring-buffer .0 .contents").highlight({color: "#60a0d0", duration: ANIMATION_PAUSE})
       $(".ring-buffer .0 .contents").effect( "transfer", { to: $( ".disruptor-command-bus .commandHandlingEntry" ) }, ANIMATION_PAUSE, function () {
         $(".disruptor-command-bus .commandHandlingEntry").html("#1")
       }).dequeue().effect( "transfer", { to: $( ".disruptor-command-bus .sequence" ) }, ANIMATION_PAUSE, function () {
         $(".disruptor-command-bus .sequence").html("0");
         next();
       });
     }, 
     function () {
       $(".disruptor-command-bus .aggregateId").fadeIn(ANIMATION_PAUSE, next)
     },
     function () {
       $(".disruptor-command-bus .aggregateId").highlight({color: "#60a0d0", duration: ANIMATION_PAUSE})
       $(".disruptor-command-bus .aggregateId").effect( "transfer", { to: $( ".disruptor-command-bus .invokerSegment" ) }, ANIMATION_PAUSE, function () {
         $(".disruptor-command-bus .invokerSegment").html("0");
         next()
       });
     }, 
     function () {
       $(".ring-buffer .0 .contents").highlight({color: "#60a0d0", duration: ANIMATION_PAUSE})
       $(".ring-buffer .0 .contents")
        .effect( "transfer", { to: $( ".command-handler-invoker .0 .currentSequence" ) }, ANIMATION_PAUSE).dequeue()
        .effect( "transfer", { to: $( ".command-handler-invoker .1 .currentSequence" ) }, ANIMATION_PAUSE).dequeue()
        .effect( "transfer", { to: $( ".command-handler-invoker .2 .currentSequence" ) }, ANIMATION_PAUSE).dequeue()
        .effect( "transfer", { to: $( ".command-handler-invoker .3 .currentSequence" ) }, ANIMATION_PAUSE, animateNext).dequeue()
     }, 
     function () {
       $(".disruptor-command-bus").highlight({color: "#60a0d0", duration: ANIMATION_PAUSE})
       $(".ring-buffer .0 .contents").highlight({color: "#6080a0"}, ANIMATION_PAUSE)
       $(".command-handler-invoker .currentSequence").highlight({color: "#6080a0"}, ANIMATION_PAUSE, animateNext)
     }, 
     function () {
       $(".disruptor-command-bus .invokerSegment").highlight({color: "#60a0d0", duration: ANIMATION_PAUSE})
       $(".command-handler-invoker .0 .segmentId").highlight({color: "#60a0d0", duration: ANIMATION_PAUSE})
       $(".command-handler-invoker .0 .processing").highlight({color: "#60a0d0", duration: ANIMATION_PAUSE})
       $(".command-handler-invoker .1 .segmentId").highlight({color: "red"}, ANIMATION_PAUSE)
       $(".command-handler-invoker .2 .segmentId").highlight({color: "red"}, ANIMATION_PAUSE)
       $(".command-handler-invoker .3 .segmentId").highlight({color: "red"}, ANIMATION_PAUSE)
       $(".command-handler-invoker .0 .processing").html("Yes")
       $(".command-handler-invoker .1 .currentSequence").html("1")
       $(".command-handler-invoker .2 .currentSequence").html("1")
       $(".command-handler-invoker .3 .currentSequence").html("1")
     }
   ]; 
 var disruptorCommandBusModel = {
   name: "disruptor command bus",
   data: [
     {
       commandHandlingEntry: "#1",
       aggregateId: "0d2b8c57-7ba0-4914-9fc0-e7ee0813a367",
       sequence: 0,
       invokerSegment: 0
     }
   ]
 };
 var ringBufferModel = {
   name: "ring buffer",
   data: [
     {
       sequence: 0,
       contents: "CommandHandlingEntry #1"
     },
     {
       sequence: 1,
       contents: "CommandHandlingEntry #2"
     },
     {
       sequence: 2,
       contents: "CommandHandlingEntry #3"
     },
     {
       sequence: 3,
       contents: "CommandHandlingEntry #4"
     },
   ]
 };
 var commandHandlerInvokerModel = {
   name: "command handler invoker",
   data: [
     {
       segmentId: 0,
       currentSequence: 0,
       processing: "No"
     },
     {
       segmentId: 1,
       currentSequence: 0,
       processing: "No"
     },
     {
       segmentId: 2,
       currentSequence: 0,
       processing: "No"
     },
     {
       segmentId: 3,
       currentSequence: 0,
       processing: "No"
     },
   ]
 };
 $("#main").append(createHorizontalTable(disruptorCommandBusModel))
 $("#main").append(createVerticalTable(ringBufferModel));
 $("#main").append(createVerticalTable(commandHandlerInvokerModel));
  var ringBuffer = function () {
   var svg = d3.select("body")
      .append("svg")
        .attr("width", "1200px")
        .attr("height", "1200px")
    var radius = 200;
    var arc = d3.svg.arc()
        .outerRadius(radius - 10)
        .innerRadius(radius - 70);

    var pie = d3.layout.pie()
        .value(function(d) { return d; });

    var ringBuffer = svg.append("g")
      .attr("class", "ring-buffer")
      .attr("transform", "translate(" + 600 + "," + 300 + ")")

    var g = ringBuffer.selectAll(".arc")
          .data(pie([1, 1, 1, 1]))
          .enter().append("g")
          .attr("class", function (d, idx) { return idx; })
          .append("g")
          .attr("class", function (d, idx) { return "arc sequence contents"; });

      g.append("path")
          .attr("class", function (d, i) { return "sequence contents"; })
          .attr("d", arc)

      g.append("text")
          .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
          .attr("dy", ".35em")
          .style("text-anchor", "middle")
  }();
 $(".disruptor-command-bus .aggregateId").hide()
 $(".disruptor-command-bus .invokerSegment").hide()
 var state = {commands: toProcess, done: function () { commands.shift()(this) } };
 next(state);
});
</script>
<body id="main">
</body> 
