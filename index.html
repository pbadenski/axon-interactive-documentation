<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
<script src="gsap-timeline-slider.js"></script>
<script src="animations.js"></script>
<script src="views.js"></script>
<style>
rect {
  opacity: 0.5;
  fill: white;
  stroke: black;
}
path {
  opacity: 0.5;
  fill: white;
  stroke: black;
}
.effects-transfer {
  border: 3px dotted black;
}
</style>
<script>
$(function () {
  var ANIMATION_PAUSE = 2;
  var initializeAggregateIdInDisruptorCommandBus = function (aggregateId) {
       return function () { 
         return [
           highlight($(".disruptor-command-bus .aggregateId"), ANIMATION_PAUSE/2),
           TweenLite.delayedCall(0, function () { 
            $(".disruptor-command-bus .aggregateId").html(aggregateId); 
           }),
           highlight($(".messages .0"), ANIMATION_PAUSE/2),
           TweenLite.to($(".messages .0"), 1, {opacity: 1, height: 100, backgroundColor: "#60a0d0"})
         ]};
     };
  var assignInvokerId = function () {
       return [
         highlight($(), ANIMATION_PAUSE/2),
         transfer({from: $(".disruptor-command-bus .aggregateId"), to: $(".disruptor-command-bus .invokerSegment"  )}, ANIMATION_PAUSE),
         TweenLite.delayedCall(0, function () { 
          $(".disruptor-command-bus .invokerSegment").html(0); 
         }),
         highlight($(".messages .1"), ANIMATION_PAUSE/2),
         TweenLite.to($(".messages .1"), 1, {opacity: 1, height: 100, backgroundColor: "#60a0d0"})
       ]
     };
  var nextSequenceFromRingBuffer = function () {
     return [
       transfer({from: $(".ring-buffer .0 .contents"), to: $( ".disruptor-command-bus .sequence" )}, ANIMATION_PAUSE),
       TweenLite.delayedCall(0, function () { $(".disruptor-command-bus .sequence").html("0") }),
       highlight($(".messages .2"), ANIMATION_PAUSE/2),
       TweenLite.to($(".messages .2"), 1, {opacity: 1, height: 100, backgroundColor: "#60a0d0"})
     ]
   }; 
  var getEventForSequence = function () {
     return [
       highlight($(".disruptor-command-bus .sequence"), ANIMATION_PAUSE),
       transfer({from: $(".ring-buffer .0 .contents"), to: $( ".disruptor-command-bus .commandHandlingEntry" )}, ANIMATION_PAUSE),
       TweenLite.delayedCall(0, function () { $(".disruptor-command-bus .commandHandlingEntry").html("#1"); }),
       highlight($(".messages .3"), ANIMATION_PAUSE/2),
       TweenLite.to($(".messages .3"), 1, {opacity: 1, height: 100, backgroundColor: "#60a0d0"})
     ]
   };
  var publishEventForSequence = function () {
     return [
       highlight($(".ring-buffer .0 .contents"), ANIMATION_PAUSE),
       highlight($(".disruptor-command-bus .commandHandlingEntry"), ANIMATION_PAUSE),
       highlight($(".messages .4"), ANIMATION_PAUSE/2),
       TweenLite.to($(".messages .4"), 1, {opacity: 1, height: 100, backgroundColor: "#60a0d0"})
     ]
   };

  var frames = [ 
     initializeAggregateIdInDisruptorCommandBus("0d2b8c57-7ba0-4914-9fc0-e7ee0813a367"),
     assignInvokerId,
     nextSequenceFromRingBuffer,
     getEventForSequence,
     publishEventForSequence,
     function () {
       return [
         transfer({from: $(".ring-buffer .0 .contents"), to: $(".command-handler-invoker .currentSequence")}, ANIMATION_PAUSE),
         highlight($(".messages .5"), ANIMATION_PAUSE/2),
         TweenLite.to($(".messages .5"), 1, {opacity: 1, height: 100, backgroundColor: "#60a0d0"})
       ]
     }, 
     function () {
       return [
         highlight($(".disruptor-command-bus"), ANIMATION_PAUSE),
         highlight($(".ring-buffer .0 .contents"), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .currentSequence"), ANIMATION_PAUSE)]
     }, 
     function () {
       return [
         TweenLite.delayedCall(0, function () { 
           $(".command-handler-invoker .0 .processing").html("Yes")
           $(".command-handler-invoker .1 .currentSequence").html("1")
           $(".command-handler-invoker .2 .currentSequence").html("1")
           $(".command-handler-invoker .3 .currentSequence").html("1")
         }),
         highlight($(".disruptor-command-bus .invokerSegment"), ANIMATION_PAUSE),
         highlight($(".command-handler-invokey .0 .segmentId"), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .0 .processing"), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .1 .segmentId", {color: "red"}), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .2 .segmentId", {color: "red"}), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .3 .segmentId", {color: "red"}), ANIMATION_PAUSE)]
     }
   ]; 
 var disruptorCommandBusModel = {
   name: "disruptor command bus",
   data: [
     {
       commandHandlingEntry: "",
       aggregateId: "",
       sequence: "",
       invokerSegment: ""
     }
   ]
 };
 var ringBufferModel = {
   name: "ring buffer",
   data: [
     {
       sequence: 0,
       contents: "CommandHandlingEntry #1"
     },
     {
       sequence: 1,
       contents: "CommandHandlingEntry #2"
     },
     {
       sequence: 2,
       contents: "CommandHandlingEntry #3"
     },
     {
       sequence: 3,
       contents: "CommandHandlingEntry #4"
     },
   ]
 };
 var commandHandlerInvokerModel = {
   name: "command handler invoker",
   data: [
     {
       segmentId: 0,
       currentSequence: 0,
       processing: "No"
     },
     {
       segmentId: 1,
       currentSequence: 0,
       processing: "No"
     },
     {
       segmentId: 2,
       currentSequence: 0,
       processing: "No"
     },
     {
       segmentId: 3,
       currentSequence: 0,
       processing: "No"
     },
   ]
 };
 $("#main").append(createHorizontalTable(disruptorCommandBusModel))
 var addRingBuffer = function (where) {
  var svg = d3.select("#main")
     .append("svg")
       .style("float", "left")
       .attr("width", "400px")
       .attr("height", "400px")
   var radius = 200;
   var arc = d3.svg.arc()
       .outerRadius(radius - 10)
       .innerRadius(radius - 70);

   var pie = d3.layout.pie()
       .value(function(d) { return d; });

   var ringBuffer = svg.append("g")
     .attr("class", "ring-buffer")
     .attr("transform", "translate(" + 200 + "," + 200 + ")")

   var g = ringBuffer.selectAll(".arc")
         .data(pie([1, 1, 1, 1]))
         .enter().append("g")
         .attr("class", function (d, idx) { return idx; })
         .append("g")
         .attr("class", function (d, idx) { return "arc sequence contents"; });

     g.append("path")
         .attr("class", function (d, i) { return "sequence contents"; })
         .attr("d", arc)

     g.append("text")
         .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
         .attr("dy", ".35em")
         .style("text-anchor", "middle")
 }();
 // $("#main").append(createVerticalTable(ringBufferModel));
 $("#main").append(createVerticalTable(commandHandlerInvokerModel));

 var animation = new TimelineMax({paused: true})
 animation.add(_.first(frames)())
 _.each(_.rest(frames), function (frame) {
   animation.add(frame(), "+=" + ANIMATION_PAUSE)
 });
 animation.play();
});
</script>
<body>
  <div id="slider"></div>
  <div id="main"></div>
  <br style="clear: both"></div>
  <div class="messages">
    <div class="5" style="padding: 10px; height: 0; opacity: 0">
          LMax BatchEventProcessor fetches next available sequence from the RingBuffer
          <pre><a href="https://github.com/LMAX-Exchange/disruptor/blob/3.3.2/src/main/java/com/lmax/disruptor/BatchEventProcessor.java#L116-L128" target="_blank">long nextSequence = sequence.get() + 1L;</a></pre>
         and then delegates it to all consumers - in this case all instances of CommandHandlerInvoker
          <pre><a href="https://github.com/LMAX-Exchange/disruptor/blob/3.3.2/src/main/java/com/lmax/disruptor/BatchEventProcessor.java#L116-L128" target="_blank">eventHandler.onEvent(event, nextSequence, nextSequence == availableSequence);</a></pre>
    </div>
    <div class="4" style="padding: 10px; height: 0; opacity: 0">
          DisruptorCommandBus publishes the sequence to ring buffer, making CommandHandlingEntry available to be consumed.
          <pre><a href="https://github.com/LMAX-Exchange/disruptor/blob/3.3.2/src/main/java/com/lmax/disruptor/BatchEventProcessor.java#L116-L128" target="_blank">ringBuffer.publish(sequence);</a></pre>
         and then delegates it to all instances of CommandHandlerInvoker
          <pre><a href="https://github.com/LMAX-Exchange/disruptor/blob/3.3.2/src/main/java/com/lmax/disruptor/BatchEventProcessor.java#L116-L128" target="_blank">eventHandler.onEvent(event, nextSequence, nextSequence == availableSequence);</a></pre>
    </div>
    <div class="3" style="padding: 10px; height: 0; opacity: 0">
      Based on the current sequence DisruptorCommandBus fetches the instance of CommandHandlingEntry from RingBuffer.
<pre><a href="https://github.com/AxonFramework/AxonFramework/blob/axon-2.4.x/core/src/main/java/org/axonframework/commandhandling/disruptor/DisruptorCommandBus.java#L287" target="_blank">CommandHandlingEntry event = ringBuffer.get(sequence);</a></pre>
 CommandHandlingEntry will then be initialized with current context data. 
    </div>
    <div class="2" style="padding: 10px; height: 0; opacity: 0">
      DisruptorCommandBus pulls next available sequence from the ring buffer: <pre><a href="https://github.com/AxonFramework/AxonFramework/blob/axon-2.4.x/core/src/main/java/org/axonframework/commandhandling/disruptor/DisruptorCommandBus.java#L285" target="_blank">long sequence = ringBuffer.next();</a></pre>
    </div>
    <div class="1" style="padding: 10px; height: 0; opacity: 0">
      InvokerSegment is assigned based on the consistent hash of aggregateId: <pre><a href="https://github.com/AxonFramework/AxonFramework/blob/axon-2.4.x/core/src/main/java/org/axonframework/commandhandling/disruptor/DisruptorCommandBus.java#L275" target="_blank">invokerSegment = idHash % commandHandlerInvokers.length;</a></pre>
    </div>
    <div class="0" style="padding: 10px; height: 0; opacity: 0">
      AggregateIdentifier for the command being currently processed is identified:
      <pre><a href="https://github.com/AxonFramework/AxonFramework/blob/axon-2.4.x/core/src/main/java/org/axonframework/commandhandling/disruptor/DisruptorCommandBus.java#L271" target="_blank">Object aggregateIdentifier = commandTargetResolver.resolveTarget(command).getIdentifier();</a></pre>
    </div>
  </div>
</body> 
