<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
<script src="animations.js"></script>
<script src="views.js"></script>
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
<style>
rect {
  opacity: 0.5;
  fill: white;
  stroke: black;
}
path {
  opacity: 0.5;
  fill: white;
  stroke: black;
}
.effects-transfer {
  border: 3px dotted black;
}
.pure-table tr th {
  border-bottom: 1px solid #cbcbcb;
}
.messages div {
  padding: 10px;
  height: 0;
  opacity: 0;
}
</style>
<script>
$(function () {
  var ANIMATION_PAUSE = 1.5;
  var newMessage = function (idx) {
     return [
       TweenLite.to($(".messages ." + (idx - 1)), 1, {backgroundColor: "white"}),
       TweenLite.to($(".messages ." + idx), 1, {height: "auto"}), 
       TweenLite.to($(".messages ." + idx), 1, {
         opacity: 1, 
         backgroundColor: "rgba(96, 160, 208, 0.5)",
      })
     ]
  }
  var initializeAggregateIdInDisruptorCommandBus = function (aggregateId) {
       return function () { 
         return [
           highlight($(".disruptor-command-bus .aggregateId"), ANIMATION_PAUSE/2),
           TweenLite.delayedCall(0, function () { 
            $(".disruptor-command-bus .aggregateId").html(aggregateId); 
           })
         ]};
     };
  var assignInvokerId = function () {
       return [
         highlight($(), ANIMATION_PAUSE/2),
         transfer({from: $(".disruptor-command-bus .aggregateId"), to: $(".disruptor-command-bus .invokerSegment"  )}, ANIMATION_PAUSE),
         TweenLite.delayedCall(0, function () { 
          $(".disruptor-command-bus .invokerSegment").html(0); 
         })
       ]
     };
  var nextSequenceFromRingBuffer = function () {
     return [
       transfer({from: $(".ring-buffer .0 .contents"), to: $( ".disruptor-command-bus .sequence" )}, ANIMATION_PAUSE),
       TweenLite.delayedCall(0, function () { $(".disruptor-command-bus .sequence").html("0") })
     ]
   }; 
  var getEventForSequence = function () {
     return [
       highlight($(".disruptor-command-bus .sequence"), ANIMATION_PAUSE),
       transfer({from: $(".ring-buffer .0 .contents"), to: $( ".disruptor-command-bus .commandHandlingEntry" )}, ANIMATION_PAUSE),
       TweenLite.delayedCall(0, function () { $(".disruptor-command-bus .commandHandlingEntry").html("#1"); })
     ]
   };
  var publishEventForSequence = function () {
     return [
       highlight($(".ring-buffer .0 .contents"), ANIMATION_PAUSE),
       highlight($(".disruptor-command-bus .commandHandlingEntry"), ANIMATION_PAUSE)
     ]
   };

  var frames = [ 
     initializeAggregateIdInDisruptorCommandBus("0d2b8c57-7ba0-4914-9fc0-e7ee0813a367"),
     assignInvokerId,
     nextSequenceFromRingBuffer,
     getEventForSequence,
     publishEventForSequence,
     function () {
       return [
         transfer({from: $(".ring-buffer .0 .contents"), to: $(".command-handler-invoker .currentSequence")}, ANIMATION_PAUSE)
       ]
     }, 
     function () {
       return [
         highlight($(".disruptor-command-bus"), ANIMATION_PAUSE),
         highlight($(".ring-buffer .0 .contents"), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .currentSequence"), ANIMATION_PAUSE)]
     }, 
     function () {
       return [
         TweenLite.delayedCall(0, function () { 
           $(".command-handler-invoker .0 .processing").html("Yes")
           $(".command-handler-invoker .1 .currentSequence").html("1")
           $(".command-handler-invoker .2 .currentSequence").html("1")
           $(".command-handler-invoker .3 .currentSequence").html("1")
         }),
         highlight($(".disruptor-command-bus .invokerSegment"), ANIMATION_PAUSE),
         highlight($(".command-handler-invokey .0 .segmentId"), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .0 .processing"), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .1 .segmentId", {color: "red"}), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .2 .segmentId", {color: "red"}), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .3 .segmentId", {color: "red"}), ANIMATION_PAUSE)]
     }
   ]; 
 var disruptorCommandBusModel = {
   name: "disruptor command bus",
   data: [
     {
       commandHandlingEntry: "",
       aggregateId: "",
       sequence: "",
       invokerSegment: ""
     }
   ]
 };
 var ringBufferModel = {
   name: "ring buffer",
   data: [
     {
       sequence: 0,
       contents: "CommandHandlingEntry #1"
     },
     {
       sequence: 1,
       contents: "CommandHandlingEntry #2"
     },
     {
       sequence: 2,
       contents: "CommandHandlingEntry #3"
     },
     {
       sequence: 3,
       contents: "CommandHandlingEntry #4"
     },
   ]
 };
 var commandHandlerInvokerModel = {
   name: "command handler invoker",
   data: [
     {
       segmentId: 0,
       currentSequence: 0,
       processing: "No"
     },
     {
       segmentId: 1,
       currentSequence: 0,
       processing: "No"
     },
     {
       segmentId: 2,
       currentSequence: 0,
       processing: "No"
     },
     {
       segmentId: 3,
       currentSequence: 0,
       processing: "No"
     },
   ]
 };
 $("#main").append(createHorizontalTable(disruptorCommandBusModel))
 var addRingBuffer = function (where) {
  var svg = d3.select("#main")
     .append("svg")
       .style("float", "left")
       .attr("width", "400px")
       .attr("height", "400px")
   var radius = 200;
   var arc = d3.svg.arc()
       .outerRadius(radius - 10)
       .innerRadius(radius - 70);

   var pie = d3.layout.pie()
       .value(function(d) { return d; });

   var ringBuffer = svg.append("g")
     .attr("class", "ring-buffer")
     .attr("transform", "translate(" + 200 + "," + 200 + ")")

   var g = ringBuffer.selectAll(".arc")
         .data(pie([1, 1, 1, 1]))
         .enter().append("g")
         .attr("class", function (d, idx) { return idx; })
         .append("g")
         .attr("class", function (d, idx) { return "arc sequence contents"; });

     g.append("path")
         .attr("class", function (d, i) { return "sequence contents"; })
         .attr("d", arc)

     g.append("text")
         .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
         .attr("dy", ".35em")
         .style("text-anchor", "middle")
 }();
 // $("#main").append(createVerticalTable(ringBufferModel));
 $("#main").append(createVerticalTable(commandHandlerInvokerModel));
 $("table").addClass("pure-table pure-table-bordered")

 frames = _.map(frames, function (frame, idx) {
  return function () { return [frame(), newMessage(idx)] };
 })
 var animation = new TimelineMax({paused: true, ease: Quad.easeOut})
 animation.add("0")
 animation.add(_.first(frames)())
 _.each(_.rest(frames), function (frame, idx) {
   animation.add("" + idx)
   animation.add(frame(), "+=" + ANIMATION_PAUSE)
 });
 $("#play.paused").click(function () { 
    animation.paused(!$(this).hasClass("paused"));
    $(this).toggleClass("paused") 
    if ($(this).hasClass("paused")) {
      $(this).html("play")
    } else {
      $(this).html("||")
    }
 });
 var animationControl = {
   enable: function () { $("#slider *").prop("disabled", false); },
   disable: function () { $("#slider *").prop("disabled", true); }
 }
 $("#play").not(".paused").click(function () { animation.pause(); });
 $("#prev").click(function () { 
   animationControl.disable()
   animation.seek(animation.getLabelBefore()); 
   animation.seek(Math.max(0, animation.getLabelTime(animation.getLabelBefore()))); 
   animation.tweenTo(animation.getLabelAfter(), {ease: Quad.easeOut, onComplete: animationControl.enable}); 
 });
 $("#next").click(function () { 
   animationControl.disable()
   animation.tweenTo(animation.getLabelAfter(), {onComplete: animationControl.enable}); 
 });
});
</script>
<body>
  <div id="slider" style="padding: 15px">
    <button id="prev">prev</button>
    <button id="play" class="paused">play</button>
    <button id="next">next</button>
  </div>
  <div id="main"></div>
  <br style="clear: both"></div>
  <div class="messages">
    <div class="5">
          LMax BatchEventProcessor fetches next available sequence from the RingBuffer
          <pre><a href="https://github.com/LMAX-Exchange/disruptor/blob/3.3.2/src/main/java/com/lmax/disruptor/BatchEventProcessor.java#L116-L128" target="_blank">long nextSequence = sequence.get() + 1L;</a></pre>
         and then delegates it to all consumers - in this case all instances of CommandHandlerInvoker
          <pre><a href="https://github.com/LMAX-Exchange/disruptor/blob/3.3.2/src/main/java/com/lmax/disruptor/BatchEventProcessor.java#L116-L128" target="_blank">eventHandler.onEvent(event, nextSequence, nextSequence == availableSequence);</a></pre>
    </div>
    <div class="4">
          DisruptorCommandBus publishes the sequence to ring buffer, making CommandHandlingEntry available to be consumed.
          <pre><a href="https://github.com/LMAX-Exchange/disruptor/blob/3.3.2/src/main/java/com/lmax/disruptor/BatchEventProcessor.java#L116-L128" target="_blank">ringBuffer.publish(sequence);</a></pre>
         and then delegates it to all instances of CommandHandlerInvoker
          <pre><a href="https://github.com/LMAX-Exchange/disruptor/blob/3.3.2/src/main/java/com/lmax/disruptor/BatchEventProcessor.java#L116-L128" target="_blank">eventHandler.onEvent(event, nextSequence, nextSequence == availableSequence);</a></pre>
    </div>
    <div class="3">
      Based on the current sequence DisruptorCommandBus fetches the instance of CommandHandlingEntry from RingBuffer.
<pre><a href="https://github.com/AxonFramework/AxonFramework/blob/axon-2.4.x/core/src/main/java/org/axonframework/commandhandling/disruptor/DisruptorCommandBus.java#L287" target="_blank">CommandHandlingEntry event = ringBuffer.get(sequence);</a></pre>
 CommandHandlingEntry will then be initialized with current context data. 
    </div>
    <div class="2">
      DisruptorCommandBus pulls next available sequence from the ring buffer: <pre><a href="https://github.com/AxonFramework/AxonFramework/blob/axon-2.4.x/core/src/main/java/org/axonframework/commandhandling/disruptor/DisruptorCommandBus.java#L285" target="_blank">long sequence = ringBuffer.next();</a></pre>
    </div>
    <div class="1">
      InvokerSegment is assigned based on the consistent hash of aggregateId: <pre><a href="https://github.com/AxonFramework/AxonFramework/blob/axon-2.4.x/core/src/main/java/org/axonframework/commandhandling/disruptor/DisruptorCommandBus.java#L275" target="_blank">invokerSegment = idHash % commandHandlerInvokers.length;</a></pre>
    </div>
    <div class="0">
      AggregateIdentifier for the command being currently processed is identified:
      <pre><a href="https://github.com/AxonFramework/AxonFramework/blob/axon-2.4.x/core/src/main/java/org/axonframework/commandhandling/disruptor/DisruptorCommandBus.java#L271" target="_blank">Object aggregateIdentifier = commandTargetResolver.resolveTarget(command).getIdentifier();</a></pre>
    </div>
  </div>
</body> 
