<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
<script src="animations.js"></script>
<script src="views.js"></script>
<style>
rect {
  opacity: 0.5;
  fill: white;
  stroke: black;
}
path {
  opacity: 0.5;
  fill: white;
  stroke: black;
}
.effects-transfer {
  border: 3px dotted black;
}
</style>
<script>
$(function () {
  var ANIMATION_PAUSE = 2;
  var frames = [ 
     function () {
       return [
         highlight($(".ring-buffer .0 .contents"), ANIMATION_PAUSE),
         transfer({from: $(".ring-buffer .0 .contents"), to: $( ".disruptor-command-bus .commandHandlingEntry" )}, ANIMATION_PAUSE),
         TweenLite.delayedCall(0, function () { $(".disruptor-command-bus .commandHandlingEntry").html("#1") }),
         transfer({from: $(".ring-buffer .0 .contents"), to: $( ".disruptor-command-bus .sequence" )}, ANIMATION_PAUSE),
         TweenLite.delayedCall(0, function () { $(".disruptor-command-bus .sequence").html("0"); })]
     }, 
     function () {
       return [
         TweenLite.to($(".disruptor-command-bus .invokerSegment"), ANIMATION_PAUSE, {opacity: 1}, 0),
         TweenLite.to($(".disruptor-command-bus .aggregateId"), ANIMATION_PAUSE, {opacity: 1}, 0)]
     },
     function () {
       return [
         highlight($(".disruptor-command-bus .aggregateId"), ANIMATION_PAUSE),
         transfer({from: $(".disruptor-command-bus .aggregateId"), to: $(".disruptor-command-bus .commandHandlingEntry")}, ANIMATION_PAUSE),
         TweenLite.delayedCall(0, function () { $(".disruptor-command-bus .invokerSegment").html("0"); })]
     }, 
     function () {
       return [
         highlight($(".ring-buffer .0 .contents"), ANIMATION_PAUSE),
         transfer({from: $(".ring-buffer .0 .contents"), to: $(".command-handler-invoker .currentSequence")}, ANIMATION_PAUSE)]
     }, 
     function () {
       return [
         highlight($(".disruptor-command-bus"), ANIMATION_PAUSE),
         highlight($(".ring-buffer .0 .contents"), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .currentSequence"), ANIMATION_PAUSE)]
     }, 
     function () {
       $(".command-handler-invoker .0 .processing").html("Yes")
       $(".command-handler-invoker .1 .currentSequence").html("1")
       $(".command-handler-invoker .2 .currentSequence").html("1")
       $(".command-handler-invoker .3 .currentSequence").html("1")
       return [
         highlight($(".disruptor-command-bus .invokerSegment"), ANIMATION_PAUSE),
         highlight($(".command-handler-invokey .0 .segmentId"), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .0 .processing"), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .1 .segmentId", {color: "red"}), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .2 .segmentId", {color: "red"}), ANIMATION_PAUSE),
         highlight($(".command-handler-invoker .3 .segmentId", {color: "red"}), ANIMATION_PAUSE)]
     }
   ]; 
 var disruptorCommandBusModel = {
   name: "disruptor command bus",
   data: [
     {
       commandHandlingEntry: "#1",
       aggregateId: "0d2b8c57-7ba0-4914-9fc0-e7ee0813a367",
       sequence: 0,
       invokerSegment: 0
     }
   ]
 };
 var ringBufferModel = {
   name: "ring buffer",
   data: [
     {
       sequence: 0,
       contents: "CommandHandlingEntry #1"
     },
     {
       sequence: 1,
       contents: "CommandHandlingEntry #2"
     },
     {
       sequence: 2,
       contents: "CommandHandlingEntry #3"
     },
     {
       sequence: 3,
       contents: "CommandHandlingEntry #4"
     },
   ]
 };
 var commandHandlerInvokerModel = {
   name: "command handler invoker",
   data: [
     {
       segmentId: 0,
       currentSequence: 0,
       processing: "No"
     },
     {
       segmentId: 1,
       currentSequence: 0,
       processing: "No"
     },
     {
       segmentId: 2,
       currentSequence: 0,
       processing: "No"
     },
     {
       segmentId: 3,
       currentSequence: 0,
       processing: "No"
     },
   ]
 };
 $("#main").append(createHorizontalTable(disruptorCommandBusModel))
 var addRingBuffer = function (where) {
  var svg = d3.select("#main")
     .append("svg")
       .style("float", "left")
       .attr("width", "400px")
       .attr("height", "400px")
   var radius = 200;
   var arc = d3.svg.arc()
       .outerRadius(radius - 10)
       .innerRadius(radius - 70);

   var pie = d3.layout.pie()
       .value(function(d) { return d; });

   var ringBuffer = svg.append("g")
     .attr("class", "ring-buffer")
     .attr("transform", "translate(" + 200 + "," + 200 + ")")

   var g = ringBuffer.selectAll(".arc")
         .data(pie([1, 1, 1, 1]))
         .enter().append("g")
         .attr("class", function (d, idx) { return idx; })
         .append("g")
         .attr("class", function (d, idx) { return "arc sequence contents"; });

     g.append("path")
         .attr("class", function (d, i) { return "sequence contents"; })
         .attr("d", arc)

     g.append("text")
         .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
         .attr("dy", ".35em")
         .style("text-anchor", "middle")
 }();
 // $("#main").append(createVerticalTable(ringBufferModel));
 $("#main").append(createVerticalTable(commandHandlerInvokerModel));

 $(".disruptor-command-bus .aggregateId").css({opacity: 0})
 $(".disruptor-command-bus .invokerSegment").css({opacity: 0 })
 var animation = new TimelineMax({paused: true})
 animation.add(_.first(frames))
 _.each(_.rest(frames), function (frame) {
   animation.add(frame, "+=" + ANIMATION_PAUSE)
 });
 animation.play()
});
</script>
<body id="main">
</body> 
